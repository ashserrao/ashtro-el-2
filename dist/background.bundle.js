(()=>{"use strict";const e=JSON.parse('{"D":["chrome://","edge://","examroom.ai","chrome-extension://","https://testdeliveryconsole.examroom.ai/","https://erv2devcandidate.examroom.ai/","https://nrbdevcandidate.examroom.ai/","http://localhost:5173/","https://localhost:4449/#/","https://localhost:4300/#/","https://provexam.com/"]}');console.log("background.js is working");let t,o=[],r=null,a="",n=!1,s=[],c="inProgress",i=e.D,l=[],d=[],m=0,g=!1,u="http://localhost:3000",h="/flags",f={tenantGuid:"",userGuid:"",personEventGuid:""};async function p(e,t,o,r){try{const a=new URL(e);o||Object.keys(o).forEach((e=>{a.searchParams.append(e,o[e])}));const n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error("Network response was not ok");r(null,await n.json())}catch(e){r(e,null)}}function b(e){let t={type:"live-flag",flag:e.data,blockExam:e.blockContent};chrome.tabs.sendMessage(r,t)}async function E(){if(l.includes("EXTENSIONS_DETECTION"))try{let e=await new Promise(((e,t)=>{chrome.management.getAll((o=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(o)}))})),t=[];e.forEach((e=>{e.enabled&&e.id!==chrome.runtime.id&&t.push(e.shortName)}));let o={type:"prelim-exten",data:t};if(chrome.tabs.sendMessage(r,o),t.length>0&&JSON.stringify(d)!==JSON.stringify(t)){const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional Extensions Alert",attachments:"",object:"",sender:"Examlock lite",comment:"List of extensions found: ".concat(JSON.stringify(t)),timestamp:Date.now(),key:"",status:"",proctorComment:""};b({data:e,blockContent:!1}),p("".concat(u).concat(h),e,f,(t=>{t?(s.push(e),console.log("Flag API failed")):console.log("Flag API Success")})),d=t}}catch(e){console.error("Error retrieving extensions:",e)}}function w(e){if(!1===e&&!1===g){g=!0;const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Extension disabled for incognito",attachments:"",object:"",sender:"Examlock lite",comment:"Extension disabled for incognito tabs within the browser.",timestamp:Date.now(),key:"",status:"",proctorComment:""};b({data:e,blockContent:!1}),p("".concat(u).concat(h),e,f,(t=>{t?(s.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}else!0===e&&!0===g&&(g=!1)}chrome.runtime.onInstalled.addListener((()=>{chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{const t=e.url;!i.some((e=>t.includes(e)))&&l.includes("TAB_BLOCKING")&&"inProgress"===c?chrome.tabs.remove(e.id):chrome.tabs.reload(e.id)}))}))})),chrome.tabs.onUpdated.addListener((()=>{chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{if(!i.some((t=>e.url.includes(t)))&&l.includes("TAB_BLOCKING")&&"inProgress"===c){const t={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional tab opened",attachments:"",object:"",sender:"Examlock lite",comment:"Additional tab was opened by the candidate. url: ".concat(e.url),timestamp:Date.now(),key:"",status:"",proctorComment:""};b({data:t,blockContent:!1}),p("".concat(u).concat(h),t,f,(e=>{e?(s.push(t),console.log("Flag API failed")):console.log("Flag API Success")})),chrome.tabs.remove(e.id)}}))}))})),chrome.runtime.onConnect.addListener((e=>{"devtools"===e.name&&l.includes("DEVTOOLS_DETECTION")&&e.onMessage.addListener((e=>{"openDevTools"===e.name&&fetch("https://api64.ipify.org?format=json").then((e=>e.json())).then((e=>{t=e.ip,console.log("Current System IP:",t),function(){chrome.tabs.query({currentWindow:!0},(e=>{l=[],chrome.tabs.create({url:"https://examroom.ai/34pizy6/"}),e.forEach((e=>{"https://examroom.ai/34pizy6/"===e.url?console.log("you tried to hack us page"):(chrome.tabs.sendMessage(e.id,{type:"devtools-found",message:"I'm from the service worker."}),chrome.tabs.remove(e.id))}))}));const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Devtools Alert",attachments:"",object:"",sender:"Examlock lite",comment:"Dev tools detected on browser logged network ID ".concat(t),timestamp:Date.now(),key:"",status:"",proctorComment:""};b({data:e,blockContent:!1}),p("".concat(u).concat(h),e,f,(t=>{t?(s.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}()})).catch((e=>{console.error("Error fetching IP address:",e)}))}))})),chrome.runtime.onMessage.addListener(((e,t,r)=>{var a;"recording-page"===e.action?r("page triggered"):"id-cards"===e.action||"face-capture"===e.action?(e.data.forEach((e=>{o.push(e)})),console.log(o),r("received "+("id-cards"===e.action?"ID's":"Face photo"))):"record-tab"===e.action?r("recorded-tab"):"switch-tab"===e.action?r("switched-tab"):"check-recording-status"===e.action?r(n):"switch-recording-status"===e.action?console.log(n):"getFlags"===e.action?s&&(r(s[0]),s.shift()):"sendFlags"===e.action?(b(e),p("".concat(u).concat(h),e.data,f,(t=>{t?(s.push(e.data),console.log("Flag API failed")):console.log("Flag API Success")})),r("Flag received.")):"content-blocked"===e.action||("check-incognito"===e.action?chrome.extension.isAllowedIncognitoAccess().then(w):"unistall-exten"===e.action&&(a="chrome://extensions/",chrome.tabs.query({},(function(e){let t=e.find((e=>e.url===a));t?(chrome.tabs.update(t.id,{active:!0}),chrome.windows.update(t.windowId,{focused:!0})):chrome.tabs.create({url:a})}))))})),chrome.runtime.onMessageExternal.addListener(((e,t)=>{if(r=t.tab.id,a=t.tab.url,e.trigger&&"start_exam"===e.trigger){console.log("start_exam extension"),l=e.requiredFeatures,c="inProgress",f.personEventGuid=e.data.personEventGuid?e.data.personEventGuid:"",f.tenantGuid=e.data.tenantGuid?e.data.tenantGuid:"",f.userGuid=e.data.userGuid?e.data.userGuid:"";let t={type:"activate-fullscreen",message:"I'm from the service worker."};chrome.tabs.sendMessage(r,t),console.log("triggered start_exam"),chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{i.some((t=>e.url.includes(t)))||chrome.tabs.remove(e.id)}))}))}else if(e.trigger&&"reset_exam"===e.trigger)l=[],chrome.storage.local.clear((()=>{chrome.runtime.lastError?console.error("Error clearing local storage:",chrome.runtime.lastError):console.log("Local storage cleared.")})),chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{chrome.tabs.reload(e.id)}))}));else if(e.trigger&&"prelim-test"===e.trigger)l=e.requiredFeatures,E();else if(e.trigger&&"anchor-redirect"===e.trigger)null!==r?chrome.tabs.update(r,{active:!0},(function(e){chrome.runtime.lastError?console.error("Error switching tab:",chrome.runtime.lastError.message):console.log("Switched back to tab:",e)})):console.log("No main tab ID saved.");else if(e.trigger&&"proc-fullscreen-request"===e.trigger){let e={type:"activate-fullscreen",message:"I'm from the service worker."};chrome.tabs.sendMessage(r,e)}})),chrome.tabs.onActivated.addListener((e=>{chrome.tabs.get(e.tabId,(e=>{e.url.includes(a)&&l.includes("LOST_FOCUS_DETECTION")&&chrome.windows.onFocusChanged.addListener((e=>{if(e===chrome.windows.WINDOW_ID_NONE){const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Lost focus detected",attachments:"",object:"",sender:"Examlock lite",comment:"Candidate is not on the examination window",timestamp:Date.now(),key:"",status:"",proctorComment:""};b({data:e,blockContent:!1}),p("".concat(u).concat(h),e,f,(t=>{t?(s.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}}))}))})),setInterval((()=>{l.forEach(((e,t)=>{chrome.storage.local.set({["requestFeature_".concat(t)]:e})})),E(),chrome.system.display.getInfo((e=>{if(chrome.runtime.lastError)return void console.error("Error:",chrome.runtime.lastError.message);const t=e.length;if(t>1&&t!==m&&l.includes("DUAL_SCREEN_DETECTION")){m=t;const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional Display Alert",attachments:"",object:"",sender:"Examlock lite",comment:"Total displays found: ".concat(t),timestamp:Date.now(),key:"",status:"",proctorComment:""};b({data:e,blockContent:!1}),p("".concat(u).concat(h),e,f,(t=>{t?(s.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}else 1===t&&l.includes("DUAL_SCREEN_DETECTION")&&(m=t)})),l.includes("INCOGNITO_DETECTION")&&chrome.extension.isAllowedIncognitoAccess().then(w),null!==r&&chrome.tabs.sendMessage(r,{type:"setInterval-trigger"})}),5e3)})();