(()=>{"use strict";const e=JSON.parse('{"DS":["chrome://","edge://","chrome-extension://","examroom.ai","https://testdeliveryconsole.examroom.ai/","https://erv2devcandidate.examroom.ai/","https://nrbdevcandidate.examroom.ai/","http://localhost:5173/","https://localhost:4449/#/","https://localhost:4300/#/"]}');console.log("background.js is working");let t,o=null,n="",a=e.DS,r=[],s=[],c=0,i=!1,l="http://localhost:3000",d="/flags",m={tenantGuid:"",userGuid:"",personEventGuid:""},g="Online",u=!1,h=[],f=[];function p(e){chrome.tabs.query({},(function(t){let o=t.find((t=>t.url===e));o?(chrome.tabs.update(o.id,{active:!0}),chrome.windows.update(o.windowId,{focused:!0})):chrome.tabs.create({url:e})}))}async function b(e,t,o,n){try{const a=new URL(e);o||Object.keys(o).forEach((e=>{a.searchParams.append(e,o[e])}));const r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error("Network response was not ok");n(null,await r.json())}catch(e){n(e,null)}}function E(e){let t={type:"live-flag",flag:e.data,blockExam:e.blockContent};chrome.tabs.sendMessage(o,t),"Standalone"===g?console.log("extension raised HTTPS flag"):"Offline"===g&&console.log("Flag sent to Indexed DB")}async function w(){if(r.includes("EXTENSIONS_DETECTION"))try{let e=await new Promise(((e,t)=>{chrome.management.getAll((o=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(o)}))})),t=[];e.forEach((e=>{e.enabled&&e.id!==chrome.runtime.id&&t.push(e.shortName)}));let n={type:"prelim-exten",data:t};if(chrome.tabs.sendMessage(o,n),t.length>0&&JSON.stringify(s)!==JSON.stringify(t)){const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional Extensions Alert",attachments:"",object:"",sender:"Examlock lite",comment:"List of extensions found: ".concat(JSON.stringify(t)),timestamp:Date.now(),key:"",status:"",proctorComment:""};E({data:e,blockContent:!1}),b("".concat(l).concat(d),e,m,(t=>{t?(f.push(e),console.log("Flag API failed")):console.log("Flag API Success")})),s=t}}catch(e){console.error("Error retrieving extensions:",e)}}function y(e){if(!1===e&&!1===i){i=!0;const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Extension disabled for incognito",attachments:"",object:"",sender:"Examlock lite",comment:"Extension disabled for incognito tabs within the browser.",timestamp:Date.now(),key:"",status:"",proctorComment:""};E({data:e,blockContent:!1}),b("".concat(l).concat(d),e,m,(t=>{t?(f.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}else!0===e&&!0===i&&(i=!1)}chrome.runtime.onInstalled.addListener((()=>{chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{const t=e.url;!a.some((e=>t.includes(e)))&&r.includes("TAB_BLOCKING")?chrome.tabs.remove(e.id):chrome.tabs.reload(e.id)}))})),chrome.tabs.query({currentWindow:!1},(e=>{e.forEach((e=>{chrome.tabs.remove(e.id)}))}))})),chrome.tabs.onUpdated.addListener((()=>{chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{if(!a.some((t=>e.url.includes(t)))&&r.includes("TAB_BLOCKING")){const t={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional tab opened",attachments:"",object:"",sender:"Examlock lite",comment:"Additional tab was opened by the candidate. url: ".concat(e.url),timestamp:Date.now(),key:"",status:"",proctorComment:""};E({data:t,blockContent:!1}),b("".concat(l).concat(d),t,m,(e=>{e?(f.push(t),console.log("Flag API failed")):console.log("Flag API Success")})),chrome.tabs.remove(e.id)}"chrome://extensions/"===e.url&&r.includes("TAB_BLOCKING")&&E({data:{flag_type:"RED",transfer_to:"Don't Transfer",reason:"Extensions page opened",attachments:"",object:"",sender:"Examlock lite",comment:"Chrome extensions tab was opened",timestamp:Date.now(),key:"",status:"",proctorComment:""},blockContent:!1})}))})),chrome.tabs.query({currentWindow:!1},(e=>{e.forEach((e=>{if(!a.some((t=>e.url.includes(t)))&&r.includes("TAB_BLOCKING")){const t={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional tab opened",attachments:"",object:"",sender:"Examlock lite",comment:"Additional tab was opened by the candidate. url: ".concat(e.url),timestamp:Date.now(),key:"",status:"",proctorComment:""};E({data:t,blockContent:!1}),b("".concat(l).concat(d),t,m,(e=>{e?(f.push(t),console.log("Flag API failed")):console.log("Flag API Success")})),chrome.tabs.remove(e.id)}"chrome://extensions/"===e.url&&r.includes("TAB_BLOCKING")&&E({data:{flag_type:"RED",transfer_to:"Don't Transfer",reason:"Extensions page opened",attachments:"",object:"",sender:"Examlock lite",comment:"Chrome extensions tab was opened",timestamp:Date.now(),key:"",status:"",proctorComment:""},blockContent:!1})}))}))})),chrome.runtime.onConnect.addListener((e=>{"devtools"===e.name&&e.onMessage.addListener((e=>{"openDevTools"===e.name&&fetch("https://api64.ipify.org?format=json").then((e=>e.json())).then((e=>{t=e.ip,console.log("Current System IP:",t),function(){chrome.tabs.query({currentWindow:!0},(e=>{r=[],p("https://examroom.ai/34pizy6/"),e.forEach((e=>{"https://examroom.ai/34pizy6/"===e.url&&console.log("you tried to hack us page")}))})),chrome.tabs.query({currentWindow:!1},(e=>{r=[],e.forEach((e=>{}))}));const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Devtools Alert",attachments:"",object:"",sender:"Examlock lite",comment:"Dev tools detected on browser logged network ID ".concat(t),timestamp:Date.now(),key:"",status:"",proctorComment:""};E({data:e,blockContent:!1}),b("".concat(l).concat(d),e,m,(t=>{t?(f.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}()})).catch((e=>{console.error("Error fetching IP address:",e)}))}))})),chrome.runtime.onMessage.addListener(((e,t,o)=>{"recording-page"===e.action?o("page triggered"):"id-cards"===e.action||"face-capture"===e.action?(e.data.forEach((e=>{h.push(e)})),console.log(h),o("received "+("id-cards"===e.action?"ID's":"Face photo"))):"record-tab"===e.action?o("recorded-tab"):"switch-tab"===e.action?o("switched-tab"):"check-recording-status"===e.action?o(u):"switch-recording-status"===e.action?console.log(u):"getFlags"===e.action?f&&(o(f[0]),f.shift()):"sendFlags"===e.action?(E(e),b("".concat(l).concat(d),e.data,m,(t=>{t?(f.push(e.data),console.log("Flag API failed")):console.log("Flag API Success")})),o("Flag received.")):"content-blocked"===e.action||("check-incognito"===e.action?chrome.extension.isAllowedIncognitoAccess().then(y):"unistall-exten"===e.action&&p("chrome://extensions/"))})),chrome.runtime.onMessageExternal.addListener(((e,t,c)=>{if(o=t.tab.id,n=t.tab.url,e.trigger&&"start_exam"===e.trigger){console.log("start_exam extension"),r=e.requiredFeatures,m.personEventGuid=e.data.personEventGuid?e.data.personEventGuid:"",m.tenantGuid=e.data.tenantGuid?e.data.tenantGuid:"",m.userGuid=e.data.userGuid?e.data.userGuid:"";let t={type:"activate-fullscreen",message:"I'm from the service worker."};r.includes("FULLSCREEN_DETECTION")&&chrome.tabs.sendMessage(o,t),chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{a.some((t=>e.url.includes(t)))||chrome.tabs.remove(e.id)}))}))}else if(e.trigger&&"reset_exam"===e.trigger)r=[],chrome.storage.local.clear((()=>{chrome.runtime.lastError?console.error("Error clearing local storage:",chrome.runtime.lastError):console.log("Local storage cleared.")})),chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{chrome.tabs.reload(e.id)}))}));else if(e.trigger&&"prelim-test"===e.trigger)s=[],r=e.requiredFeatures,w(),setTimeout((()=>{console.log(s),s.length>0?c(!0):c(!1),r=[]}),2e3);else if(e.trigger&&"anchor-redirect"===e.trigger)null!==o?chrome.tabs.update(o,{active:!0},(function(e){chrome.runtime.lastError?console.error("Error switching tab:",chrome.runtime.lastError.message):console.log("Switched back to tab:",e)})):console.log("No main tab ID saved.");else if(e.trigger&&"proc-fullscreen-request"===e.trigger){let e={type:"activate-fullscreen",message:"I'm from the service worker."};chrome.tabs.sendMessage(o,e)}else if(e.trigger&&"examlocklite-installed"===e.trigger)c(!0);else if(e.trigger&&"get-screen-stream"===e.trigger)return chrome.desktopCapture.chooseDesktopMedia(["screen"],t.tab,(e=>{c({streamId:e})})),!0})),chrome.tabs.onActivated.addListener((e=>{chrome.tabs.get(e.tabId,(e=>{e.url.includes(n)&&r.includes("LOST_FOCUS_DETECTION")&&chrome.windows.onFocusChanged.addListener((e=>{if(e===chrome.windows.WINDOW_ID_NONE){const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Lost focus detected",attachments:"",object:"",sender:"Examlock lite",comment:"Candidate is not on the examination window",timestamp:Date.now(),key:"",status:"",proctorComment:""};E({data:e,blockContent:!1}),b("".concat(l).concat(d),e,m,(t=>{t?(f.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}}))}))})),setInterval((()=>{r.forEach(((e,t)=>{chrome.storage.local.set({["requestFeature_".concat(t)]:e})})),w(),chrome.system.display.getInfo((e=>{if(chrome.runtime.lastError)return void console.error("Error:",chrome.runtime.lastError.message);const t=e.length;if(t>1&&t!==c&&r.includes("DUAL_SCREEN_DETECTION")){c=t;const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional Display Alert",attachments:"",object:"",sender:"Examlock lite",comment:"Total displays found: ".concat(t),timestamp:Date.now(),key:"",status:"",proctorComment:""};E({data:e,blockContent:!1}),b("".concat(l).concat(d),e,m,(t=>{t?(f.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}else 1===t&&r.includes("DUAL_SCREEN_DETECTION")&&(c=t)})),r.includes("INCOGNITO_DETECTION")&&chrome.extension.isAllowedIncognitoAccess().then(y),null!==o&&(chrome.tabs.sendMessage(o,{type:"setInterval-trigger"}),console.log("Service worker log"))}),5e3)})();