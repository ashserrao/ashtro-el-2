(()=>{"use strict";const e=JSON.parse('{"DS":["chrome://","edge://","chrome-extension://","examroom.ai","https://testdeliveryconsole.examroom.ai/","https://erv2devcandidate.examroom.ai/","https://nrbdevcandidate.examroom.ai/","http://localhost:5173/","https://localhost:4449/#/","https://localhost:4300/#/"]}');console.log("background.js is working");let t,o=null,n="",r=e.DS,a=[],s=[],c=0,l=!1,i=!1,d="http://localhost:3000",m="/flags",u={tenantGuid:"",userGuid:"",personEventGuid:""},g="ONLINE",h=!1,f=[],p=[];function E(e){chrome.tabs.query({},(function(t){let o=t.find((t=>t.url===e));o?(chrome.tabs.update(o.id,{active:!0}),chrome.windows.update(o.windowId,{focused:!0})):chrome.tabs.create({url:e})}))}async function b(e,t,o,n){try{const r=new URL(e);o||Object.keys(o).forEach((e=>{r.searchParams.append(e,o[e])}));const a=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw new Error("Network response was not ok");n(null,await a.json())}catch(e){n(e,null)}}function w(e){let t={type:"live-flag",flag:e.data,blockExam:e.blockContent};chrome.tabs.sendMessage(o,t),"STANDALONE"===g?console.log("extension raised HTTPS flag"):"Offline"===g&&console.log("Flag sent to Indexed DB")}async function y(){if(a.includes("EXTENSIONS_DETECTION"))try{let e=await new Promise(((e,t)=>{chrome.management.getAll((o=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(o)}))})),t=[];e.forEach((e=>{e.enabled&&e.id!==chrome.runtime.id&&t.push(e.shortName)}));let n={type:"prelim-exten",data:t};if(chrome.tabs.sendMessage(o,n),t.length>0&&JSON.stringify(s)!==JSON.stringify(t)){const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional Extensions Alert",attachments:"",object:"",sender:"Examlock lite",comment:"List of extensions found: ".concat(JSON.stringify(t)),timestamp:Date.now(),key:"",status:"",proctorComment:""};w({data:e,blockContent:!1}),b("".concat(d).concat(m),e,u,(t=>{t?(p.push(e),console.log("Flag API failed")):console.log("Flag API Success")})),s=t}}catch(e){console.error("Error retrieving extensions:",e)}}function I(e){if(!1===e&&!1===l){l=!0;const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Extension disabled for incognito",attachments:"",object:"",sender:"Examlock lite",comment:"Extension disabled for incognito tabs within the browser.",timestamp:Date.now(),key:"",status:"",proctorComment:""};w({data:e,blockContent:!1}),b("".concat(d).concat(m),e,u,(t=>{t?(p.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}else!0===e&&!0===l&&(l=!1)}"chrome://extensions/".concat(chrome.runtime.id,"/recording.html"),chrome.runtime.onInstalled.addListener((()=>{chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{const t=e.url;!r.some((e=>t.includes(e)))&&a.includes("TAB_BLOCKING")?chrome.tabs.remove(e.id):chrome.tabs.reload(e.id)}))})),chrome.tabs.query({currentWindow:!1},(e=>{e.forEach((e=>{chrome.tabs.remove(e.id)}))}))})),chrome.tabs.onUpdated.addListener((()=>{chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{if(!r.some((t=>e.url.includes(t)))&&a.includes("TAB_BLOCKING")){const t={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional tab opened",attachments:"",object:"",sender:"Examlock lite",comment:"Additional tab was opened by the candidate. url: ".concat(e.url),timestamp:Date.now(),key:"",status:"",proctorComment:""};w({data:t,blockContent:!1}),b("".concat(d).concat(m),t,u,(e=>{e?(p.push(t),console.log("Flag API failed")):console.log("Flag API Success")})),chrome.tabs.remove(e.id)}"chrome://extensions/"===e.url&&a.includes("TAB_BLOCKING")&&w({data:{flag_type:"RED",transfer_to:"Don't Transfer",reason:"Extensions page opened",attachments:"",object:"",sender:"Examlock lite",comment:"Chrome extensions tab was opened",timestamp:Date.now(),key:"",status:"",proctorComment:""},blockContent:!1})}))})),chrome.tabs.query({currentWindow:!1},(e=>{e.forEach((e=>{if(!r.some((t=>e.url.includes(t)))&&a.includes("TAB_BLOCKING")){const t={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional tab opened",attachments:"",object:"",sender:"Examlock lite",comment:"Additional tab was opened by the candidate. url: ".concat(e.url),timestamp:Date.now(),key:"",status:"",proctorComment:""};w({data:t,blockContent:!1}),b("".concat(d).concat(m),t,u,(e=>{e?(p.push(t),console.log("Flag API failed")):console.log("Flag API Success")})),chrome.tabs.remove(e.id)}"chrome://extensions/"===e.url&&a.includes("TAB_BLOCKING")&&w({data:{flag_type:"RED",transfer_to:"Don't Transfer",reason:"Extensions page opened",attachments:"",object:"",sender:"Examlock lite",comment:"Chrome extensions tab was opened",timestamp:Date.now(),key:"",status:"",proctorComment:""},blockContent:!1})}))}))})),chrome.runtime.onConnect.addListener((e=>{"devtools"===e.name&&e.onMessage.addListener((e=>{"openDevTools"===e.name&&fetch("https://api64.ipify.org?format=json").then((e=>e.json())).then((e=>{t=e.ip,console.log("Current System IP:",t),function(){chrome.tabs.query({currentWindow:!0},(e=>{a=[],E("https://examroom.ai/34pizy6/"),e.forEach((e=>{"https://examroom.ai/34pizy6/"===e.url&&console.log("you tried to hack us page")}))})),chrome.tabs.query({currentWindow:!1},(e=>{a=[],e.forEach((e=>{}))}));const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Devtools Alert",attachments:"",object:"",sender:"Examlock lite",comment:"Dev tools detected on browser logged network ID ".concat(t),timestamp:Date.now(),key:"",status:"",proctorComment:""};w({data:e,blockContent:!1}),b("".concat(d).concat(m),e,u,(t=>{t?(p.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}()})).catch((e=>{console.error("Error fetching IP address:",e)}))}))})),chrome.runtime.onMessage.addListener(((e,t,o)=>{"recording-page"===e.action?o("page triggered"):"id-cards"===e.action||"face-capture"===e.action?(e.data.forEach((e=>{f.push(e)})),console.log(f),o("received "+("id-cards"===e.action?"ID's":"Face photo"))):"record-tab"===e.action?o("recorded-tab"):"switch-tab"===e.action?o("switched-tab"):"check-recording-status"===e.action?o(h):"switch-recording-status"===e.action?console.log(h):"getFlags"===e.action?p&&(o(p[0]),p.shift()):"sendFlags"===e.action?(w(e),b("".concat(d).concat(m),e.data,u,(t=>{t?(p.push(e.data),console.log("Flag API failed")):console.log("Flag API Success")})),o("Flag received.")):"content-blocked"===e.action||("check-incognito"===e.action?chrome.extension.isAllowedIncognitoAccess().then(I):"unistall-exten"===e.action?E("chrome://extensions/"):"exam-stat"===e.action&&o(i))})),chrome.runtime.onMessageExternal.addListener(((e,t,c)=>{if(o=t.tab.id,n=t.tab.url,e.trigger&&"start_exam"===e.trigger){console.log("start_exam extension"),a=e.requiredFeatures,(null==e?void 0:e.allowed_Urls.length)>0&&e.allowed_Urls.forEach((e=>{r.push(e)})),u.personEventGuid=e.data.personEventGuid?e.data.personEventGuid:"",u.tenantGuid=e.data.tenantGuid?e.data.tenantGuid:"",u.userGuid=e.data.userGuid?e.data.userGuid:"";let t={type:"activate-fullscreen",message:"I'm from the service worker."};a.includes("FULLSCREEN_DETECTION")&&chrome.tabs.sendMessage(o,t,(e=>{i=e,console.log("Exam-tab status:",i)})),chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{r.some((t=>e.url.includes(t)))||chrome.tabs.remove(e.id),"chrome://extensions/"===e.url&&chrome.tabs.remove(e.id)}))}))}else if(e.trigger&&"reset_exam"===e.trigger)a=[],chrome.storage.local.clear((()=>{chrome.runtime.lastError?console.error("Error clearing local storage:",chrome.runtime.lastError):console.log("Local storage cleared.")})),chrome.tabs.query({currentWindow:!0},(e=>{e.forEach((e=>{chrome.tabs.reload(e.id)}))}));else if(e.trigger&&"prelim-test"===e.trigger)s=[],a=e.requiredFeatures,y(),setTimeout((()=>{console.log(s),s.length>0?c(!0):c(!1),a=[]}),2e3);else if(e.trigger&&"anchor-redirect"===e.trigger)null!==o&&chrome.tabs.update(o,{active:!0},(function(e){chrome.runtime.lastError&&console.error("Error switching tab:",chrome.runtime.lastError.message)}));else if(e.trigger&&"proc-fullscreen-request"===e.trigger){let e={type:"activate-fullscreen",message:"I'm from the service worker."};chrome.tabs.sendMessage(o,e)}else if(e.trigger&&"examlocklite-installed"===e.trigger)c({install:!0,webpage_connect:i});else if(e.trigger&&"get-screen-stream"===e.trigger)return chrome.desktopCapture.chooseDesktopMedia(["screen"],t.tab,(e=>{c({streamId:e})})),!0})),chrome.tabs.onActivated.addListener((e=>{chrome.tabs.get(e.tabId,(e=>{e.url.includes(n)&&a.includes("LOST_FOCUS_DETECTION")&&chrome.windows.onFocusChanged.addListener((e=>{if(e===chrome.windows.WINDOW_ID_NONE){const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Lost focus detected",attachments:"",object:"",sender:"Examlock lite",comment:"Candidate is not on the examination window",timestamp:Date.now(),key:"",status:"",proctorComment:""};w({data:e,blockContent:!1}),b("".concat(d).concat(m),e,u,(t=>{t?(p.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}}))}))})),setInterval((()=>{a.forEach(((e,t)=>{chrome.storage.local.set({["requestFeature_".concat(t)]:e})})),y(),chrome.system.display.getInfo((e=>{if(chrome.runtime.lastError)return void console.error("Error:",chrome.runtime.lastError.message);const t=e.length;if(t>1&&t!==c&&a.includes("DUAL_SCREEN_DETECTION")){c=t;const e={flag_type:"RED",transfer_to:"Don't Transfer",reason:"Additional Display Alert",attachments:"",object:"",sender:"Examlock lite",comment:"Total displays found: ".concat(t),timestamp:Date.now(),key:"",status:"",proctorComment:""};w({data:e,blockContent:!1}),b("".concat(d).concat(m),e,u,(t=>{t?(p.push(e),console.log("Flag API failed")):console.log("Flag API Success")}))}else 1===t&&a.includes("DUAL_SCREEN_DETECTION")&&(c=t)})),a.includes("INCOGNITO_DETECTION")&&chrome.extension.isAllowedIncognitoAccess().then(I),null!==o&&chrome.tabs.sendMessage(o,{type:"setInterval-trigger"},(e=>{!chrome.runtime.lastError||!0!==i&&!1!==i?(i=!0,console.log(e)):(i=!1,console.log(chrome.runtime.lastError.message),function(){let e=[];chrome.tabs.query({currentWindow:!0},(t=>{e=t.map((e=>e.id)),console.log(e),console.log("Exam tab found:",e.includes(o)),console.log(a),!e.includes(o)&&a.length>0&&E("chrome-extension://".concat(chrome.runtime.id,"/disconnected.html"))}))}())}))}),5e3)})();